# Elasticsearch basic

다음과 같은 것들을 정리했다. 
- 엘라스틱 서치를 배우기 위해 먼저 알아야하는 사전 지식들 위주로 정리 (용어와 개념 등)
- 키바나에서 어떻게 학습 테스트를 해볼 수 있는지 위주로.
- Index 와 Document 개념에 대해서
- Document 의 CRUD 에 대해서
- 인덱스 매핑에 대해서 
- 인덱스 템플릿에 대해서
- Elasticsearch 에 사용하는 Analyzer 에 대해서 

*** 

## 엘라스틱 서치 요청과 응답

엘라스틱 서치는 요청과 응답을 모두 REST API 를 통해서 제공해준다.

REST API 는 리소스를 접근에 대해서 일정한 규칙을 정한 것이다. 

여기서는 키바나 Dev Tools 에 있는 콘솔을 이용해서 REST API 를 호출하면서 테스트를 해본다. 

### 시스템 상태 확인 

엘라스틱 서치에서늖 현재 상태를 확인할 수 있는 방법으로 `cat API` 를 사용하면 된다. 

cat API 에서는 Node, Shard, Template 등의 상태 정보나 통계 정보를 확인할 수 있다. 

cat API 를 통해서 클러스터 내부의 인덱스 목록을 확인하고 싶다면 `GET _cat/indice?v` API 를 호출하면 된다. 
- v 파라미터는 ㅋ라럼의 이름을 확인할 수 있고 이외에도 여러 파라미터가 있다. 

물론 키바나 웹페이지에서 클러스터의 내부 상태를 관리할 수 있지만 터미널 또는 API 를 직접 호출함을 통해서도 상태 체크가 가능하다. 

터미널에서는 `curl -X GET "localhost:9200/_cat/indices?v"` 를 호출하면 된다

## 인덱스와 도큐먼트 

엘라스틱 서치를 이해하기 위해서는 인덱스와 도큐먼트의 이해가 무척 중요하다. 

하나의 인덱스안에 여러 도큐먼트가 있는 구조이고

인덱스는 관계형 데이터베이스로 치면 테이블, 도큐먼트는 테이블 안에 있는 레코드라고 생각하면 편하다.

일반적으로 엘라스틱서치를 이용해서 시스템을 개발하면 하나의 프로젝트에 하나의 클러스터를 생성하고 클러스터 내부는 데이터 성격에 따라서 여러 개의 인덱스를 생성한다. 

### 도큐먼트 

도큐먼트는 엘라스틱 서치에서 기본으로 저장되는 단위로 JSON 형태이다.

엘라스틱 서치에 있는 개념들을 관계형 디비랑 비교하면 다음과 같다.

|MySQL|Elasticsearch|
|:---:|:---:|
|테이블 | 인덱스 |
|레코드 | 도큐먼트 |
|칼럼 | 필드 |
|스키마 | 매핑 |

__참고로 엘라스턱 7.x 버전에서는 type 이 존재했어서 관계형 디비와의 비교가 가능했는데 지금은 유효하지는 않다고한다.__

### 인덱스

하나의 인덱스에 다수의 도큐먼트가 포함되는 구조이다.

동일한 인덱스에 있는 도큐먼트는 동일한 스키마를 가진다. 

그리고 모든 도큐먼트는 하나의 인덱스에 포함되어야한다.

**스키마에 따른 그룹핑**
- 당연한 소리지만 인덱스는 스키마에 따라서 구분한다.
- 회원 스키마와 장바구니 스키마는 다를 것이므로 다른 인덱스로 하는게 낫다.
- 굳이 모든 요소를 포함하는 스키마를 세우는건 비효율적이다 라는 소리다.

**관리 목적의 그룹핑**
- 기본적으로 인덱스 하나에 무한개의 도큐먼트를 넣을 수 있다.
- 하지만 하나의 인덱스에 수억개의 도큐먼트가 포함된다면 성능이 나오진 않을 것이다.
- 그래서 엘라스틱 서치를 운영할 때 인덱스 용량 제한을 두게된다.
- 기본적으로는 도큐먼트 개수가 일정 개수를 넘어가거나 일정 용량을 넘어가게 되면 인덱스를 분리한다.
- 가장 기본적으로 사용하는 케이스는 날짜 별로 분리하는 것이다. 이렇게 하면 날짜별로 데이터가 분리될 것이다.
- 주로 월별로 인덱스를 분리한다.

## 도큐먼트 CRUD

도큐먼트를 엘라스틱서치에 저장하고 CRUD 하는 동작에 대해서 소개하곘다. 

인덱스 생성과 삭제 조회에 대해서 먼저 보자. 
- 인덱스 생성: `PUT index1 or POST index1`
- 인덱스 조회: `GET index1`
- 인덱스 삭제: `DELETE index1` 

인덱스를 삭제하면 인덱스 내부에 저장되어있는 도큐먼트는 모두 삭제된다. 

### 도큐먼트 생성 

엘라스틱서치에서 도큐먼트를 인덱스에 포함시키는 과정을 인덱싱 (Indexing) 이라고 부른다. 

인덱싱을 해보자.

```json
PUT index1/_doc/1
{
  "name": "mike",
  "age", 20,
  "gender": "male"
}
```
- 이렇게 호출하면 존재하지 않았던 index1 이 생기고 동시에 인덱스1에 document 가 생긴다. 
- _doc 는 엔드포인트 구분을 위한 예약어이고 숫자 1은 도큐먼트의 id 이다.
- 도큐먼트에는 age,name,gender 필드가 있고 각 필드에는 값이 있다.

이를 조회홰보자. `GET index1`

```json
{
  "index1": {
    "alias": {},
    "mappings": {
      "properties": {
        "age": { "type":  "long" ...},
        "gender": { "type":  "text", ...},
        "name": {"type": "text", ...}
      }
    },
    ...
  }
}
```
- index1 에서 생긴 필드들을 보면 age 는 long 타입, gender 와 name 은 모두 text 타입으로 **자동 생성** 되었다.
- 엘라스틱서치는 만들려는 도큐먼트의 필드를 보고 자동으로 스키마 즉 매핑을 생성하는데 이를 다아나믹 매핑이라고 부른다.
- 다이나믹 매핑은 이후에 자세히 설명하겠지만 추천하지는 않는다. 미리 어떤 타입이 올 지 알고있다면.

index1 에 새로운 필드를 가진 도큐먼트를 넣으면 어떻게 될까? 

데이터는 인덱스에 들어가게 되고 인덱스 mappings.properties 에 새로운 필드들이 추가된다. 

그리고 다른 예로 age 가 이미 숫자 필드로 등록되어 있는데 문자열로 데이터를 넘기면 어떻게 될까? 

이 경우에는 자동으로 타입변환이 된다.

엘라스틱서치의 대표적인 타입변환은 다음과 같다.
- 숫자 필드에 문자열이 입력되면 자동으로 숫자로 변환하려고 시도한다.
- 정수 필드에 소수가 입력되면 소수점 아래를 무시한다.

### 도큐먼트 읽기

이번에는 도큐먼트를 읽어보자. 

도큐먼트를 읽는 방법은 Id 로 조회하는 방법과 DSL (Domain Specific Language) 를 통해서 검색하는 방법이 있다. 

우선 도큐먼트 아이디를 사용해 조회하는 방법은 다음과 같다.

`GET index1/_doc/{id}`

하지만 실제로 빅데이터 세상에서는 도큐먼트를 하나씩 읽어오는 경우는 드물다. 다른 방법으로는 search 라는 DSL 쿼리를 통해서 도큐먼트를 읽어올 수 있다.

`GET index1/_search`

- _search DSL 쿼리를 사용하면 index1 에 있는 모든 도큐먼트를 가져온다.

### 도큐먼트 수정 

도큐먼트 수정을 할려면 `PUT index1/_doc/{id}` 하고 넣을 JSON 데이터를 전달하면 된다. 

사실 이건 덮어쓰기의 과정이다.

update API 를 하면 특정 도큐먼트의 값을 업데이트 할 수 있다.

```json
POST index1/_update/1
{
  "doc": {
    "name": "lee"
  }
}
```
- _update 라는 엔드포인트를 추가해서 특정 필드의 값만 업데이트 하는게 가능하다.
- 엘라스틱서치의 경우 도큐먼트 수정 비용이 비싼편이기 떄문에 추천하지는 않는다. 

### 도큐먼트 삭제

마지막으로 도큐먼트 삭제이다.

`DELETE index1/_doc/{id}` 를 하면 도큐먼트가 삭제된다.

*** 

## 응답 메시지

엘라스틱서치에서는 REST API 를 통해서 호출한다고 이전에 설명했었다.

이 경우 요청에 문제가 있거나 엘라스틱서치 서버에 문제가 있어서 성공적인 응답을 내리지 못할수도 있는데 이 경우의 상태 코드를 보자.

|코드|상태|해결방법
|:---:|:---:|:---:|
|200,201| 정상적으로 수행함| 
|4xx| 클라이언트 오류 | 클라이언트에서 문제를 해결해야함
|404| 요청한 리소스가 없음 | 인덱스나 도큐먼트가 존재하는지 체크|
|405| 요청 메소드 (POST, GET 등) 을 지원하지 않음| API 사용법 체크
|429| 요청 과부하 (Busy) | 재전송, 노드 추가 같은 조치 |
|5xx| 서버 오류| 엘라스틱서치 로그 확인 후 조치|

***

## 벌크 데이터 

데이터 CRUD 동작을 할 땐 REST API 를 호출해서 하나하나 도큐먼트를 요청하는 것보다 한번에 보내는게 더 나을 수 있다. 

엘라스틱서치에서는 이와 같은 bulk API 를 지원한다. 

bulk API 의 포맷은 다음과 같다.

```json
POST _bulk
{"index": {"_index":  "test", "_id": "1"}}
{"field1": "value1"}
{"create": {"_index": "test", "_id":"3"}}
{"field1": "value3"}
{"update": {"_id": "1", "_index": "test"}}
{"doc": {"field2": "value2"}}
{"delete": {"_index": "test", "_id": "2"}}
```
- bulk API 는 도큐먼트 읽기는 지원하지 않고 도큐먼트 생성/수정/삭제 만 지원한다.
- 포맷을 보면 알겠지만 삭제만 한 줄로 처리하고 나머지는 두 줄로 구성된다.
- 각 줄 사이에는 쉼표 등 별도의 구분자가 포함되지 않고 빈 줄을 허용하지 않는다.
- JSON 문법처럼 보이지만 복수의 JSON 구조를 줄바꿈 문자열로 구분하는 NDJSON (New-line Delimited JSON) 형태다.
- JSON 과 비슷하지만 문법이 조금 다르니 쉼표 사용에 주의하자

이 포맷에 맞춰서 index2 인덱스에 2 개의 도큐먼트를 벌크 형태로 넣어보자.

```json
POST _bulk
{"index":  {"_index": "index2", "_id": "4"}}
{"name": "park", "age":  30, "gender": "male"}
{"index":  {"_index": "index2", "_id": "5"}}
{"name": "jung", "age":  50, "gender": "male"}
```

이 요청을 터미널로 보낼려면 다음과 같이 보내면 된다.

`curl -H "Content-Type: application/x-ndjson -XPOST localhost:9200/_bulk --data-binary "@./bulk_index2"`

- curl 의 H 옵션은 헤더를 지칭한다.
- X 는 사용할 HTTP Method 를 나타내며 -XPOST 는 POST 방식으로 호출한단 뜻이다. 
- `_bulk` 는 bulk API 를 호출하는 것이다.
- `--data-binary` 는 POST 메소드에 우리가 전달할려는 파일을 바이너리 형태로 전송한단 뜻이다.
- 참고오 여기서 전달할려는 파일이 JSON 형식으로 되어있다면 오류가 발생한다. NDJSON 형태로 되어있어야 한다.

***

## 매핑

관계형 데이터베이스가 스키마 설정이 있는 것처럼 엘라스틱서치에서도 매팽 설정이라는 것이 있다. 

이는 JSON 형태의 데이터를 루씬이 이해할 수 있도록 바꿔주는 작업이다. 

엘라스틱서치가 전문검색과 대용량 데이터를 빠르게 실시간 검색이 가능한 이유가 매핑이 있기 때문이다. 

매핑을 사용자가 직접하면 명시적 매핑, 엘라스틱서치가 도와주면 다이나믹매핑이다. 

여기서는 이것들에 대해서 알아보자.  
- 매핑 설정 방법과 
- 좋은 매핑이 무엇인지
- 매핑할 때 사용하는 데이터 타입이 무엇인지 
- 특히 매핑에서 문자열 타입이 text 와 keyword 로 나눠지는데 이를 이해하는게 중요하다.




